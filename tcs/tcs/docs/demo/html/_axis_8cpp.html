<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>tpk demo: D:/tpk/src/demo/Axis.cpp File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1-p1 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<h1>D:/tpk/src/demo/Axis.cpp File Reference</h1><code>#include &quot;<a class="el" href="_axis_8h.html">Axis.h</a>&quot;</code><br>
<code>#include &quot;math.h&quot;</code><br>
<code>#include &quot;tpk.h&quot;</code><br>

<p>
Include dependency graph for Axis.cpp:<p><center><img src="_axis_8cpp__incl.png" border="0" usemap="#D:/tpk/src/demo/Axis.cpp_map" alt=""></center>
<map name="D:/tpk/src/demo/Axis.cpp_map">
<area href="_axis_8h.html" shape="rect" coords="227,56,285,83" alt="">
<area href="commands_8h.html" shape="rect" coords="336,56,435,83" alt="">
</map>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#cae96e288bafa7cfaead966943e7e212">DTINY</a>&nbsp;&nbsp;&nbsp;1e-10</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#21269619a1f5cc392fc1752c1b6ecd1b">DHUGE</a>&nbsp;&nbsp;&nbsp;1e10</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#f13728317d775e044a3190457d157b42">PEMAXI</a>&nbsp;&nbsp;&nbsp;200.0</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#c070c630889ed55cbf0a577efc521e0a">sign</a>(A, B)&nbsp;&nbsp;&nbsp;((B)&lt;0.0?-(A):(A))</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#c214a15f7dd76ae866148829d1c17882">PEOLD</a>&nbsp;&nbsp;&nbsp;history-&gt;peold</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#41346a5530c37356b8675c8edae16df3">ACCUMN</a>&nbsp;&nbsp;&nbsp;history-&gt;accumn</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#c56e680bdfdb02e2c44f39c0b6f90102">ACCUMF</a>&nbsp;&nbsp;&nbsp;history-&gt;accumf</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#2074b9a2c1c6a3190319241fd96ebdd5">V0</a>&nbsp;&nbsp;&nbsp;history-&gt;v0</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#37b5516cb2ef7cfc5c81d5524c7d8099">VM1</a>&nbsp;&nbsp;&nbsp;history-&gt;vm1</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#0e5d243898332d428375f24c83f3fc1d">VM2</a>&nbsp;&nbsp;&nbsp;history-&gt;vm2</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#39432794b4de06380e46af8c18ee020c">NINPOS</a>&nbsp;&nbsp;&nbsp;history-&gt;ninpos</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_axis_8cpp.html#09f789319ce6099c3fa97bab0aaaad0c">servo</a> (int ir,double vcale,double gs,double gp,double gi,double pi,double gd,double va,double pnear,int npnear,double dpmin,double dpmax,double dvmax,double damax,double djmax,double pd,double pt,double vt,<a class="el" href="structservoh.html">servoh</a> *history,double *vd,int *inpos)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Servo routine: called in order to determine what velocity to demand.  <a href="#09f789319ce6099c3fa97bab0aaaad0c"></a><br></td></tr>
</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="c56e680bdfdb02e2c44f39c0b6f90102"></a><!-- doxytag: member="Axis.cpp::ACCUMF" ref="c56e680bdfdb02e2c44f39c0b6f90102" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ACCUMF&nbsp;&nbsp;&nbsp;history-&gt;accumf          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="41346a5530c37356b8675c8edae16df3"></a><!-- doxytag: member="Axis.cpp::ACCUMN" ref="41346a5530c37356b8675c8edae16df3" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ACCUMN&nbsp;&nbsp;&nbsp;history-&gt;accumn          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="21269619a1f5cc392fc1752c1b6ecd1b"></a><!-- doxytag: member="Axis.cpp::DHUGE" ref="21269619a1f5cc392fc1752c1b6ecd1b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DHUGE&nbsp;&nbsp;&nbsp;1e10          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="cae96e288bafa7cfaead966943e7e212"></a><!-- doxytag: member="Axis.cpp::DTINY" ref="cae96e288bafa7cfaead966943e7e212" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DTINY&nbsp;&nbsp;&nbsp;1e-10          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="39432794b4de06380e46af8c18ee020c"></a><!-- doxytag: member="Axis.cpp::NINPOS" ref="39432794b4de06380e46af8c18ee020c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NINPOS&nbsp;&nbsp;&nbsp;history-&gt;ninpos          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="f13728317d775e044a3190457d157b42"></a><!-- doxytag: member="Axis.cpp::PEMAXI" ref="f13728317d775e044a3190457d157b42" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PEMAXI&nbsp;&nbsp;&nbsp;200.0          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="c214a15f7dd76ae866148829d1c17882"></a><!-- doxytag: member="Axis.cpp::PEOLD" ref="c214a15f7dd76ae866148829d1c17882" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PEOLD&nbsp;&nbsp;&nbsp;history-&gt;peold          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="c070c630889ed55cbf0a577efc521e0a"></a><!-- doxytag: member="Axis.cpp::sign" ref="c070c630889ed55cbf0a577efc521e0a" args="(A, B)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define sign          </td>
          <td>(</td>
          <td class="paramtype">A,         <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">B&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%">&nbsp;&nbsp;&nbsp;((B)&lt;0.0?-(A):(A))</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="2074b9a2c1c6a3190319241fd96ebdd5"></a><!-- doxytag: member="Axis.cpp::V0" ref="2074b9a2c1c6a3190319241fd96ebdd5" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define V0&nbsp;&nbsp;&nbsp;history-&gt;v0          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="37b5516cb2ef7cfc5c81d5524c7d8099"></a><!-- doxytag: member="Axis.cpp::VM1" ref="37b5516cb2ef7cfc5c81d5524c7d8099" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define VM1&nbsp;&nbsp;&nbsp;history-&gt;vm1          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="0e5d243898332d428375f24c83f3fc1d"></a><!-- doxytag: member="Axis.cpp::VM2" ref="0e5d243898332d428375f24c83f3fc1d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define VM2&nbsp;&nbsp;&nbsp;history-&gt;vm2          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="09f789319ce6099c3fa97bab0aaaad0c"></a><!-- doxytag: member="Axis.cpp::servo" ref="09f789319ce6099c3fa97bab0aaaad0c" args="(int ir,double vcale,double gs,double gp,double gi,double pi,double gd,double va,double pnear,int npnear,double dpmin,double dpmax,double dvmax,double damax,double djmax,double pd,double pt,double vt,servoh *history,double *vd,int *inpos)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void servo           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>vcale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>gs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>gp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>gi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>pi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>gd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>va</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>pnear</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>npnear</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>dpmin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>dpmax</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>dvmax</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>damax</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>djmax</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>pd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>pt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>vt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structservoh.html">servoh</a> *&nbsp;</td>
          <td class="paramname"> <em>history</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>vd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>inpos</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Servo routine: called in order to determine what velocity to demand. 
<p>
<dl class="note" compact><dt><b>Note:</b></dt><dd>This routine is not conscious of either the units of position or the time per iteration. It is up to the caller to choose units appropriate to the circumstances. The units are defined by the following relationships.</dd></dl>
<ul>
<li>vcale: This parameter controls the extent to which the anti- wind-up margin is increased with increasing velocity. It is a fraction which is guaranteed to exceed the velocity feedforward calibration error. A maximum 5% error (for example) corresponds to vcale=0.05. The anti-wind-up margin, pi, is increased by vcale*va.</li></ul>
<p>
<ul>
<li>gs: If "slewing", a contribution gs*sqrt(pe) is added to the velocity demand (with due regard to signs). The slewing state is invoked when the proportional law would demand a higher velocity than the sqrt law.</li></ul>
<p>
<ul>
<li>gp: In the non-slew case, a contribution gp*pe is added to the velocity demand.</li></ul>
<p>
<ul>
<li>gi: In the non-slew case, on each iteration the position error pe is added to the integrator accum (internal to this routine). A contribution gi*accum is then added to the velocity demand. This behaviour is modified in three ways: (i) the integrator is zeroed when the flag ir is set to 0, (ii) the amount added to the integrator is limited to a numerically safe value PEMAXI, and (iii) if the position error exceeds in magnitude the anti-wind-up window pi, it is zeroed.</li></ul>
<p>
<ul>
<li>gd: In the non-slew case, a contribution equal to gd times the change in position-error since last time through is added to the velocity demand.</li></ul>
<p>
<ul>
<li>dvmax: The maximum allowed velocity is in position units per "tick" (i.e. iteration timestep).</li></ul>
<p>
<ul>
<li>damax: The maximum allowed acceleration is in position units per tick squared.</li></ul>
<p>
<ul>
<li>djmax: The maximum allowed jerk is in position units per tick cubed.</li></ul>
<p>
<dl class="note" compact><dt><b>Note:</b></dt><dd>The measures taken to prevent running hard into a position limit are (i) the position demand is limited to the specified range, and (ii) the maximum allowed velocity demand is progressively reduced as the position limits are approached, at a rate determined by the specified acceleration limit.</dd></dl>
However, it should be noted that despite these measures it is still possible to overrun slightly into the forbidden region, and it is up to the application to deal with this condition. The recommended strategy is to choose conservative position limits, leaving a buffer zone between the most extreme position demand that is accepted and the true limit.<p>
<dl class="note" compact><dt><b>Note:</b></dt><dd>The routine requires the achieved position and velocity, in essence the encoder reading and the tachometer reading. Both of these should really be for the same instant of time as for the other information (the demand position, the demand velocity and so on), and in the case of the encoder readings this may involve extrapolation.</dd></dl>
The achieved velocity may come from a tachometer, or it could come from differencing successive position-encoder readings.<p>
<dl class="note" compact><dt><b>Note:</b></dt><dd>The parameter pnear is the maximum position error that can be regarded as "near enough". The parameter npnear is the number of successive iterations on which the test must be passed. The returned argument inpos is set to true if this "near enough for long enough" test is passed, otherwise false.</dd></dl>
Note that the criteria may vary depending on what the mechanism is being used for at the time. It may also vary depending on geometrical conditions; in a two-axis "gimbal" mount, for example, pnear for the "roll" axis could be relaxed near the pole of the mount, where a large roll error corresponds to a small error in pointing direction. <dl compact><dt><b>Parameters: </b></dt><dd>
<table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em>ir</em>&nbsp;</td><td>
new move </td></tr>
<tr><td valign="top"><em>vcale</em>&nbsp;</td><td>
max velocity feedforward calibration error </td></tr>
<tr><td valign="top"><em>gs</em>&nbsp;</td><td>
gain factor for sqrt mode </td></tr>
<tr><td valign="top"><em>gp</em>&nbsp;</td><td>
gain factor for proportional part </td></tr>
<tr><td valign="top"><em>gi</em>&nbsp;</td><td>
gain factor for integral part </td></tr>
<tr><td valign="top"><em>pi</em>&nbsp;</td><td>
anti-wind-up: maximum pe for integration </td></tr>
<tr><td valign="top"><em>gd</em>&nbsp;</td><td>
gain factor for derivative part </td></tr>
<tr><td valign="top"><em>va</em>&nbsp;</td><td>
velocity advise </td></tr>
<tr><td valign="top"><em>pnear</em>&nbsp;</td><td>
"near enough" position-error test </td></tr>
<tr><td valign="top"><em>npnear</em>&nbsp;</td><td>
successive "near enough" passes needed </td></tr>
<tr><td valign="top"><em>dpmin</em>&nbsp;</td><td>
minimum allowed position demand </td></tr>
<tr><td valign="top"><em>dpmax</em>&nbsp;</td><td>
maximum allowed position demand </td></tr>
<tr><td valign="top"><em>dvmax</em>&nbsp;</td><td>
maximum allowed velocity (must be +ve) </td></tr>
<tr><td valign="top"><em>damax</em>&nbsp;</td><td>
maximum allowed acceleration ( " ) </td></tr>
<tr><td valign="top"><em>djmax</em>&nbsp;</td><td>
maximum allowed jerk ( " ) </td></tr>
<tr><td valign="top"><em>pd</em>&nbsp;</td><td>
desired position </td></tr>
<tr><td valign="top"><em>pt</em>&nbsp;</td><td>
achieved position (i.e. encoder reading) </td></tr>
<tr><td valign="top"><em>vt</em>&nbsp;</td><td>
achieved velocity (i.e. tacho reading) </td></tr>
<tr><td valign="top"><em>history</em>&nbsp;</td><td>
context variables </td></tr>
<tr><td valign="top"><em>vd</em>&nbsp;</td><td>
velocity demand </td></tr>
<tr><td valign="top"><em>inpos</em>&nbsp;</td><td>
TRUE = "near enough for long enough" </td></tr>
</table>
</dl>
</div>
</div><p>
<hr size="1"><address style="align: right;"><small>Generated on Thu Mar 1 15:48:29 2007 for tpk demo by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1-p1 </small></address>
</body>
</html>
